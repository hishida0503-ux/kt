<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ë©¶ÂêàË©≥Á¥∞ÈÄ£Áµ°„É°„Éº„Ç´„Éº v2025-11-17-perm5</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --fg: #1a1a1a;
      --card-bg: #ffffff;
      --muted: #6c757d;
      --accent: #0d6efd;
      --accent-hover: #0b5ed7;
      --border: #dee2e6;
      --success: #198754;
      --tab-inactive: #e9ecef;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1117;
        --fg: #f0f6fc;
        --card-bg: #161b22;
        --muted: #8b949e;
        --accent: #1f6feb;
        --accent-hover: #388bfd;
        --border: #30363d;
        --success: #3fb950;
        --tab-inactive: #21262d;
      }
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      padding-bottom: 80px;
    }
    
    header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      font-size: 1rem;
      font-weight: 700;
    }
    .header-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
    }
    .header-btn:active { opacity: 0.8; }
    
    .tabs {
      display: flex;
      background: var(--card-bg);
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 53px;
      z-index: 99;
    }
    .tab {
      flex: 1;
      padding: 16px 8px;
      text-align: center;
      background: var(--tab-inactive);
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s;
      position: relative;
    }
    .tab.active {
      background: var(--card-bg);
      color: var(--accent);
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    .tab-content.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    main { padding: 16px; max-width: 800px; margin: 0 auto; }
    
    .accordion-section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      cursor: pointer;
      user-select: none;
      background: var(--card-bg);
      transition: background 0.2s;
    }
    .accordion-header:active {
      background: var(--tab-inactive);
    }
    .accordion-section.completed .accordion-header {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }
    @media (prefers-color-scheme: dark) {
      .accordion-section.completed .accordion-header {
        background: linear-gradient(135deg, #1a2332 0%, #1e3a5f 100%);
      }
    }
    .accordion-title {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .accordion-icon {
      transition: transform 0.3s;
      font-size: 1.2rem;
      color: var(--muted);
    }
    .accordion-section.open .accordion-icon {
      transform: rotate(180deg);
    }
    .accordion-check {
      color: var(--success);
      font-size: 1.4rem;
      font-weight: bold;
      display: none;
      margin-right: 4px;
    }
    .accordion-section.completed > .accordion-header .accordion-check {
      display: inline;
      animation: checkPop 0.3s ease;
    }
    @keyframes checkPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 16px;
    }
    .accordion-section.open .accordion-content {
      max-height: 3000px;
      padding: 0 16px 16px;
    }
    
    /* ÈõÜÂêàÊÉÖÂ†±„ÅÆ„Éç„Çπ„Éà„Åó„Åü„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Áî® */
    .meeting-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .meeting-item .accordion-header {
      padding: 12px;
      background: var(--card-bg);
    }
    .meeting-item.completed .accordion-header {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }
    @media (prefers-color-scheme: dark) {
      .meeting-item.completed .accordion-header {
        background: linear-gradient(135deg, #1a2332 0%, #1e3a5f 100%);
      }
    }
    .meeting-item .accordion-content {
      overflow: hidden;
      transition: grid-template-rows 0.3s ease, padding 0.3s ease;
      padding-top: 0;
      padding-bottom: 0;
      padding-left: 12px;
      padding-right: 12px;
      display: grid;
      grid-template-rows: 0fr;
    }
    .meeting-item.open .accordion-content {
      padding: 0 12px 12px;
      grid-template-rows: 1fr;
    }
    .meeting-item .accordion-content > div {
      overflow: hidden;
    }
    .meeting-item .accordion-icon {
      transition: transform 0.3s;
    }
    .meeting-item.open .accordion-icon {
      transform: rotate(180deg);
    }
    
    label {
      display: block;
      font-weight: 600;
      margin: 16px 0 6px;
      font-size: 0.9rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--fg);
      font-size: 1rem;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 12px 0;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
    }
    .checkbox-item input[type="checkbox"],
    .checkbox-item input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }
    
    .dynamic-row {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    .dynamic-row-header {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: var(--accent);
    }
    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .field-row.full { grid-template-columns: 1fr; }
    .field-group { display: flex; flex-direction: column; }
    .field-group label { font-size: 0.8rem; margin: 0 0 4px; }
    .field-group input, .field-group select {
      padding: 10px;
      font-size: 0.95rem;
    }
    
    .output {
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      line-height: 1.8;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      min-height: 200px;
    }
    
    .history-item {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .history-header {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .history-text {
      font-size: 0.9rem;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      margin: 12px 0;
    }
    
    .floating-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: none;
      gap: 8px;
      z-index: 98;
    }
    .floating-actions.show { display: flex; }
    .fab {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .fab.primary {
      background: var(--accent);
      color: white;
    }
    .fab.secondary {
      background: var(--tab-inactive);
      color: var(--fg);
    }
    .fab:active { transform: scale(0.95); }
    
    .btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--fg);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      transition: all 0.2s;
    }
    .btn.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .btn:active { transform: scale(0.95); }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 1.3rem; font-weight: 700; }
    .close-btn {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: var(--muted);
      line-height: 1;
    }
    .master-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    .master-section:last-child { border-bottom: none; }
    .master-section h3 {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    .master-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .master-item {
      display: flex;
      gap: 8px;
    }
    .master-item input { flex: 1; }
    
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--fg);
      color: var(--bg);
      padding: 12px 20px;
      border-radius: 999px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 300;
    }
    .toast.show { opacity: 1; }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
  
    .match-item, .referee-item, .meeting-item {background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; overflow: hidden;}
    .match-item .accordion-header, .referee-item .accordion-header, .meeting-item .accordion-header {padding: 12px; background: var(--card-bg); display: flex; align-items: center; gap: 8px;}
    .match-item.completed .accordion-header, .referee-item.completed .accordion-header, .meeting-item.completed .accordion-header {background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);}    
    .match-item.completed .accordion-check, .referee-item.completed .accordion-check, .meeting-item.completed .accordion-check {display:inline; animation: checkPop 0.3s ease;}
    .add-row-btn {background: var(--accent); color: white; border:none; padding:8px 12px; border-radius:6px; font-size:0.85rem; cursor:pointer; font-weight:600; margin-top:8px;}
    .delete-row-btn {background:#dc3545; color:white; border:none; padding:6px 10px; border-radius:6px; font-size:0.8rem; cursor:pointer; font-weight:600;}
    .section-actions {margin-left:auto; display:flex; gap:8px; align-items:center;}
    </style>
</head>
<body>
<script>
console.log('[[perm5]] V2 loader start');
// Âº∑Âà∂ÂàùÊúüÂåñÔºàwindow.formData„ÅåÊú™ÂÆöÁæ©„Åß„ÇÇÂÆâÂÖ®Ôºâ
(function initFD(){
  if (typeof window.formData !== 'object' || window.formData === null) {
    window.formData = {};
  }
  if (!Array.isArray(window.formData.meetingRows))  window.formData.meetingRows  = [];
  if (!Array.isArray(window.formData.matchRows))    window.formData.matchRows    = [];
  if (!Array.isArray(window.formData.refereeRows))  window.formData.refereeRows  = [];
})();

(function(){
  function FD(){
    var fd; try { fd = window.formData; } catch(e) { fd = undefined; }
    if (!fd || typeof fd !== 'object') { fd = (window.formData = {}); }
    if (!Array.isArray(fd.meetingRows)) fd.meetingRows = [];
    if (!Array.isArray(fd.matchRows)) fd.matchRows = [];
    if (!Array.isArray(fd.refereeRows)) fd.refereeRows = [];
    return fd;
  }
  function relayoutSection(sectionId, renderFn){
    const sec = document.querySelector(`[data-section="${sectionId}"] .accordion-content`);
    if (!sec) return; sec.innerHTML=''; renderFn(sec);
  }
  window.renderMeetingSectionV2 = function(container){
    const fd = FD(); if (fd.meetingRows.length === 0) fd.meetingRows.push({});
    const list=document.createElement('div'); list.id='meeting-list'; container.appendChild(list);
    const renderItem=(i)=>{ const it=document.createElement('div'); it.className='meeting-item'; it.dataset.meetingIdx=i;
      const header=document.createElement('div'); header.className='accordion-header';
      const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> ÈõÜÂêàÊÉÖÂ†± ${i+1}`; title.style.fontSize='0.9rem';
      const actions=document.createElement('div'); actions.className='section-actions';
      const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
      del.onclick=(e)=>{ e.stopPropagation(); fd.meetingRows.splice(i,1); relayoutSection('meeting', renderMeetingSectionV2); if (window.checkCompletion) window.checkCompletion(); };
      const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
      actions.appendChild(del); actions.appendChild(icon);
      header.appendChild(title); header.appendChild(actions);
      const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createMeetingRow(i));
      header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
      it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
      if (i===0) it.classList.add('open'); if (window.updateMeetingCompletion) window.updateMeetingCompletion(i);
      return it; };
    for (let i=0;i<fd.meetingRows.length && i<6;i++) renderItem(i);
    const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã ÈõÜÂêàÊÉÖÂ†±„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
    addBtn.onclick=()=>{ if (fd.meetingRows.length>=6){ window.showToast && window.showToast('ÈõÜÂêàÊÉÖÂ†±„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
      fd.meetingRows.push({}); const it=renderItem(fd.meetingRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
    container.appendChild(addBtn); if (window.addNoteField) window.addNoteField(container,'meetingNote');
  };
  window.renderMatchSectionV2 = function(container){
    const fd = FD(); if (fd.matchRows.length === 0) fd.matchRows.push({});
    const list=document.createElement('div'); list.id='match-list'; container.appendChild(list);
    const renderItem=(i)=>{ const it=document.createElement('div'); it.className='match-item'; it.dataset.matchIdx=i;
      const header=document.createElement('div'); header.className='accordion-header';
      const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> Ë©¶Âêà ${i+1}`; title.style.fontSize='0.9rem';
      const actions=document.createElement('div'); actions.className='section-actions';
      const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
      del.onclick=(e)=>{ e.stopPropagation(); fd.matchRows.splice(i,1); relayoutSection('match', renderMatchSectionV2); if (window.checkCompletion) window.checkCompletion(); };
      const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
      actions.appendChild(del); actions.appendChild(icon);
      header.appendChild(title); header.appendChild(actions);
      const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createMatchRow(i));
      header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
      it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
      if (i===0) it.classList.add('open'); if (window.updateMatchCompletion) window.updateMatchCompletion(i);
      return it; };
    for (let i=0;i<fd.matchRows.length && i<6;i++) renderItem(i);
    const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã Ë©¶Âêà„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
    addBtn.onclick=()=>{ if (fd.matchRows.length>=6){ window.showToast && window.showToast('Ë©¶Âêà„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
      fd.matchRows.push({}); const it=renderItem(fd.matchRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
    container.appendChild(addBtn);
  };
  window.renderRefereeSectionV2 = function(container){
    const fd = FD(); if (fd.refereeRows.length === 0) fd.refereeRows.push({});
    const list=document.createElement('div'); list.id='referee-list'; container.appendChild(list);
    const renderItem=(i)=>{ const it=document.createElement('div'); it.className='referee-item'; it.dataset.refereeIdx=i;
      const header=document.createElement('div'); header.className='accordion-header';
      const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> ÂØ©Âà§ ${i+1}`; title.style.fontSize='0.9rem';
      const actions=document.createElement('div'); actions.className='section-actions';
      const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
      del.onclick=(e)=>{ e.stopPropagation(); fd.refereeRows.splice(i,1); relayoutSection('referee', renderRefereeSectionV2); if (window.checkCompletion) window.checkCompletion(); };
      const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
      actions.appendChild(del); actions.appendChild(icon);
      header.appendChild(title); header.appendChild(actions);
      const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createRefereeRow(i));
      header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
      it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
      if (i===0) it.classList.add('open'); if (window.updateRefereeCompletion) window.updateRefereeCompletion(i);
      return it; };
    for (let i=0;i<fd.refereeRows.length && i<6;i++) renderItem(i);
    const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã ÂØ©Âà§„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
    addBtn.onclick=()=>{ if (fd.refereeRows.length>=6){ window.showToast && window.showToast('ÂØ©Âà§„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
      fd.refereeRows.push({}); const it=renderItem(fd.refereeRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
    container.appendChild(addBtn);
  };
})();

// DOMContentLoaded Âæå„Å´ V2 „ÅßÂÜç„É¨„Ç§„Ç¢„Ç¶„Éà
document.addEventListener('DOMContentLoaded', () => {
  try {
    const relayout = (id, fn) => {
      const sec = document.querySelector(`[data-section="${id}"] .accordion-content`);
      if (!sec) return; sec.innerHTML=''; fn(sec);
    };
    if (typeof renderMeetingSectionV2 === 'function') relayout('meeting', renderMeetingSectionV2);
    if (typeof renderMatchSectionV2 === 'function')   relayout('match',   renderMatchSectionV2);
    if (typeof renderRefereeSectionV2 === 'function') relayout('referee', renderRefereeSectionV2);
  } catch(e) { console.warn('relayout error', e); }
});
</script>

  <header>
    <h1>‚öΩ Ë©¶ÂêàË©≥Á¥∞ÈÄ£Áµ°</h1>
    <button class="header-btn" id="masterBtn">„Éû„Çπ„ÇøÁÆ°ÁêÜ</button>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="input">üìù ÂÖ•Âäõ</button>
    <button class="tab" data-tab="preview">üëÅÔ∏è „Éó„É¨„Éì„É•„Éº</button>
    <button class="tab" data-tab="history">üìö Â±•Ê≠¥</button>
  </div>

  <main>
    <div class="tab-content active" id="input-content"></div>
    <div class="tab-content" id="preview-content">
      <div class="output" id="output"></div>
    </div>
    <div class="tab-content" id="history-content"></div>
  </main>

  <div class="floating-actions" id="floatingActions">
    <button class="fab primary" id="copyBtn">üìã „Ç≥„Éî„Éº</button>
    <button class="fab secondary" id="saveBtn">üíæ ‰øùÂ≠ò</button>
  </div>

  <div id="masterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">„Éû„Çπ„ÇøÁÆ°ÁêÜ</div>
        <button class="close-btn" id="closeMasterBtn">&times;</button>
      </div>
      <div id="masterSections"></div>
      <button class="btn primary" id="saveMasterBtn" style="width:100%; margin-top:16px">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const DEFAULT_MASTERS = {
      events: ["U12ÂÖ®Êó•Êú¨„Çµ„ÉÉ„Ç´„ÉºÈÅ∏ÊâãÊ®©", "Áúå„É™„Éº„Ç∞", "ÊãõÂæÖÂ§ß‰ºö"],
      eventDays: ["1Êó•ÁõÆ", "2Êó•ÁõÆ", "3Êó•ÁõÆ", "‚ë†", "‚ë°", "‚ë¢", "‰∫àÈÅ∏", "Ê±∫Âãù„Éà„Éº„Éä„É°„É≥„Éà"],
      venues: ["„Éï„Éº„Éâ„É™„Ç®„Çµ„ÉÉ„Ç´„Éº„Éï„Ç£„Éº„É´„ÉâÈùíÊú®", "Â∏ÇÊ∞ë„Ç∞„É©„Ç¶„É≥„Éâ", "ÁúåÂñ∂„Çµ„ÉÉ„Ç´„ÉºÂ†¥"],
      meetingPlaces: ["ËèäÊù±Â∞è", "Â∏ÇÊ∞ë„Ç∞„É©„Ç¶„É≥„ÉâÈßêËªäÂ†¥", "Â≠¶Ê†°Ê≠£ÈñÄÂâç", "ÁèæÂú∞"],
      staff: ["Áî∞Â≥∂„Åï„Çì", "Ê©ãÈñì„Åï„Çì", "Áü≥Áî∞"],
      referees: ["Ê©ãÈñì„Åï„Çì", "‰∫îÊúàÂ•≥„Åï„Çì", "Áü≥Áî∞"],
      uniforms: ["Ê≠£„É¶„Éã", "„Çµ„Éñ„É¶„ÉãÔºàÁôΩÔºâ", "„Çµ„Éñ„É¶„ÉãÔºàÁ¥∫Ôºâ"],
      items: ["„Çµ„ÉÉ„Ç´„ÉºÁî®ÂÖ∑‰∏ÄÂºè", "„Ç∏„É£„Ç∞", "È£≤„ÅøÁâ©", "„Éû„Ç§„Çø„Ç™„É´", "ÁùÄÊõø„Åà", "ÊòºÈ£ü", "„Ç¶„Ç£„ÉÄ„ÉºÁ≠â„ÅÆÊ†ÑÈ§äË£úÁµ¶„Çº„É™„Éº"]
    };

    const LS_KEY_HISTORY = 'templateApp.history.v2';
    const LS_KEY_MASTERS = 'templateApp.masters.v2';

    let masters = loadMasters();
    let formData = {};
    let touchStartX = 0;
    let touchEndX = 0;

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function loadMasters() {
      try {
        const raw = localStorage.getItem(LS_KEY_MASTERS);
        if (raw) {
          const loaded = JSON.parse(raw);
          return {
            events: loaded.events || DEFAULT_MASTERS.events,
            eventDays: loaded.eventDays || DEFAULT_MASTERS.eventDays,
            venues: loaded.venues || DEFAULT_MASTERS.venues,
            meetingPlaces: loaded.meetingPlaces || DEFAULT_MASTERS.meetingPlaces,
            staff: loaded.staff || DEFAULT_MASTERS.staff,
            referees: loaded.referees || DEFAULT_MASTERS.referees,
            uniforms: loaded.uniforms || DEFAULT_MASTERS.uniforms,
            items: loaded.items || DEFAULT_MASTERS.items
          };
        }
      } catch {}
      return DEFAULT_MASTERS;
    }

    function saveMasters(obj) {
      localStorage.setItem(LS_KEY_MASTERS, JSON.stringify(obj));
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(LS_KEY_HISTORY);
        if (raw) return JSON.parse(raw);
      } catch {}
      return [];
    }

    function saveHistory(hist) {
      localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(hist));
    }

    function formatDateJp(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return '';
      const [y, m, d] = yyyy_mm_dd.split('-').map(x => parseInt(x, 10));
      const dt = new Date(y, m - 1, d);
      const wdays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      return `${m}Êúà${d}Êó•(${wdays[dt.getDay()]})`;
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-content`).classList.add('active');
      
      if (tabName === 'preview') {
        renderOutput();
        document.getElementById('floatingActions').classList.add('show');
      } else {
        document.getElementById('floatingActions').classList.remove('show');
      }
      
      if (tabName === 'history') {
        renderHistory();
      }
    }

    document.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      const threshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) < threshold) return;
      
      const currentTab = document.querySelector('.tab.active').dataset.tab;
      const tabs = ['input', 'preview', 'history'];
      const currentIndex = tabs.indexOf(currentTab);
      
      if (diff > 0 && currentIndex < tabs.length - 1) {
        switchTab(tabs[currentIndex + 1]);
      } else if (diff < 0 && currentIndex > 0) {
        switchTab(tabs[currentIndex - 1]);
      }
    }

    document.getElementById('masterBtn').addEventListener('click', () => {
      renderMasterModal();
      document.getElementById('masterModal').classList.add('show');
    });

    document.getElementById('closeMasterBtn').addEventListener('click', () => {
      document.getElementById('masterModal').classList.remove('show');
    });

    function renderMasterModal() {
      const container = document.getElementById('masterSections');
      container.innerHTML = '';
      
      const masterLabels = {
        events: 'Â§ß‰ºöÂêç',
        eventDays: 'Êó•Á®ãÂå∫ÂàÜ',
        venues: '‰ºöÂ†¥Âêç',
        meetingPlaces: 'ÈõÜÂêàÂ†¥ÊâÄ',
        staff: '„Çπ„Çø„ÉÉ„Éï',
        referees: 'ÂØ©Âà§Âì°',
        uniforms: '„É¶„Éã„Éï„Ç©„Éº„É†',
        items: 'ÊåÅ„Å°Áâ©'
      };

      Object.keys(masterLabels).forEach(key => {
        const section = document.createElement('div');
        section.className = 'master-section';
        
        const title = document.createElement('h3');
        title.textContent = masterLabels[key];
        section.appendChild(title);

        const list = document.createElement('div');
        list.className = 'master-list';
        list.id = `master-${key}`;

        masters[key].forEach((item, idx) => {
          list.appendChild(createMasterItem(key, item, idx));
        });

        section.appendChild(list);

        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.textContent = '+ ËøΩÂä†';
        addBtn.style.marginTop = '12px';
        addBtn.onclick = () => {
          const newItem = createMasterItem(key, '', masters[key].length);
          list.appendChild(newItem);
          newItem.querySelector('input').focus();
        };
        section.appendChild(addBtn);

        container.appendChild(section);
      });
    }

    function createMasterItem(key, value, idx) {
      const item = document.createElement('div');
      item.className = 'master-item';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = value;
      input.placeholder = 'È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ';
      
      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.textContent = 'ÂâäÈô§';
      delBtn.style.padding = '10px';
      delBtn.onclick = () => item.remove();
      
      item.appendChild(input);
      item.appendChild(delBtn);
      return item;
    }

    function saveMastersFromModal() {
      const newMasters = {
        events: [],
        eventDays: [],
        venues: [],
        meetingPlaces: [],
        staff: [],
        referees: [],
        uniforms: [],
        items: []
      };

      Object.keys(newMasters).forEach(key => {
        const inputs = document.querySelectorAll(`#master-${key} input`);
        inputs.forEach(inp => {
          const val = inp.value.trim();
          if (val) newMasters[key].push(val);
        });
      });

      masters = newMasters;
      saveMasters(masters);
    }

    function restoreFormData() {
      const eventSelect = document.querySelector('select');
      if (eventSelect && formData.event) {
        if (masters.events.includes(formData.event)) {
          eventSelect.value = formData.event;
        } else if (formData.eventOther) {
          eventSelect.value = '__other__';
          eventSelect.dispatchEvent(new Event('change'));
          const otherInput = eventSelect.nextElementSibling;
          if (otherInput) otherInput.value = formData.eventOther;
        }
      }
      
      const dateInput = document.querySelector('input[type="date"]');
      if (dateInput && formData.date) {
        dateInput.value = formData.date;
      }
      
      const eventDaySelect = document.querySelectorAll('select')[1];
      if (eventDaySelect && formData.eventDay) {
        eventDaySelect.value = formData.eventDay;
      }
      
      const venueSelect = document.querySelectorAll('select')[2];
      if (venueSelect && formData.venue) {
        if (masters.venues.includes(formData.venue)) {
          venueSelect.value = formData.venue;
        } else if (formData.venueOther) {
          venueSelect.value = '__other__';
          venueSelect.dispatchEvent(new Event('change'));
          const otherInput = venueSelect.nextElementSibling;
          if (otherInput) otherInput.value = formData.venueOther;
        }
      }
      
      const highwayCheckbox = document.getElementById('useHighway');
      if (highwayCheckbox && formData.useHighway) {
        highwayCheckbox.checked = true;
        highwayCheckbox.dispatchEvent(new Event('change'));
        const hwInput = document.querySelector('#highway-fields input[type="text"]');
        if (hwInput && formData.highway) hwInput.value = formData.highway;
        const hwNote = document.querySelector('#highway-fields textarea');
        if (hwNote && formData.highwayNote) hwNote.value = formData.highwayNote;
      }
      
      if (formData.staff && formData.staff.length > 0) {
        formData.staff.forEach(s => {
          const cb = document.querySelector(`#checkbox-group-staff input[value="${s}"]`);
          if (cb) cb.checked = true;
        });
      }
      const staffNote = document.querySelector('[data-section="staff"] textarea');
      if (staffNote && formData.staffNote) staffNote.value = formData.staffNote;
      
      if (formData.refereeStaff && formData.refereeStaff.length > 0) {
        formData.refereeStaff.forEach(r => {
          const cb = document.querySelector(`#checkbox-group-refereeStaff input[value="${r}"]`);
          if (cb) cb.checked = true;
        });
      }
      const refereeNote = document.querySelector('[data-section="refereeStaff"] textarea');
      if (refereeNote && formData.refereeNote) refereeNote.value = formData.refereeNote;
      
      if (formData.uniform) {
        const rb = document.querySelector(`input[name="uniform"][value="${formData.uniform}"]`);
        if (rb) rb.checked = true;
      }
      const uniformNote = document.querySelector('[data-section="uniform"] textarea');
      if (uniformNote && formData.uniformNote) uniformNote.value = formData.uniformNote;
      
      if (formData.items && formData.items.length > 0) {
        formData.items.forEach(item => {
          const cb = document.querySelector(`#checkbox-group-items input[value="${item}"]`);
          if (cb) cb.checked = true;
        });
      }
      const itemsNote = document.querySelector('[data-section="items"] textarea');
      if (itemsNote && formData.itemsNote) itemsNote.value = formData.itemsNote;
      
      const carpoolTextarea = document.querySelector('[data-section="carpool"] textarea');
      if (carpoolTextarea && formData.carpool) carpoolTextarea.value = formData.carpool;
      
      formData.meetingRows.forEach((m, idx) => {
        if (m && (m.time || m.type || m.place)) {
          const meetingSection = document.querySelector(`.meeting-item[data-meeting-idx="${idx}"]`);
          if (meetingSection) {
            const selects = meetingSection.querySelectorAll('select');
            const textInputs = meetingSection.querySelectorAll('input[type="text"]');
            
            if (selects[0] && m.time) selects[0].value = m.time;
            if (selects[1] && m.type) selects[1].value = m.type;
            if (selects[2]) {
              if (m.place && masters.meetingPlaces.includes(m.place)) {
                selects[2].value = m.place;
              } else if (m.placeOther) {
                selects[2].value = '__other__';
                selects[2].dispatchEvent(new Event('change'));
                if (textInputs[0]) textInputs[0].value = m.placeOther;
              }
            }
            
            updateMeetingCompletion(idx);
          }
        }
      });
      
      const meetingNoteArea = document.querySelector('[data-section="meeting"] > textarea:last-of-type');
      if (meetingNoteArea && formData.meetingNote) {
        meetingNoteArea.value = formData.meetingNote;
      }
      
      formData.matchRows.forEach((m, idx) => {
        if (m) {
          const rows = document.querySelectorAll('[data-section="match"] .dynamic-row');
          if (rows[idx]) {
            const inputs = rows[idx].querySelectorAll('input');
            const selects = rows[idx].querySelectorAll('select');
            const textareas = rows[idx].querySelectorAll('textarea');
            const checkboxes = rows[idx].querySelectorAll('input[type="checkbox"]');
            
            if (inputs[0] && m.time) inputs[0].value = m.time;
            if (inputs[1] && m.opponent) inputs[1].value = m.opponent;
            if (selects[0] && m.duration) selects[0].value = m.duration;
            if (selects[1] && m.court) selects[1].value = m.court;
            if (checkboxes[0] && m['ÁèæÂú∞Ë™øÊï¥']) checkboxes[0].checked = true;
            if (checkboxes[1] && m['Êú™ÂÆö']) checkboxes[1].checked = true;
            if (textareas[0] && m.note) textareas[0].value = m.note;
          }
        }
      });
      
      formData.refereeRows.forEach((r, idx) => {
        if (r) {
          const rows = document.querySelectorAll('[data-section="referee"] .dynamic-row');
          if (rows[idx]) {
            const inputs = rows[idx].querySelectorAll('input');
            const selects = rows[idx].querySelectorAll('select');
            const textareas = rows[idx].querySelectorAll('textarea');
            const checkboxes = rows[idx].querySelectorAll('input[type="checkbox"]');
            
            if (inputs[0] && r.time) inputs[0].value = r.time;
            if (inputs[1] && r.opponent) inputs[1].value = r.opponent;
            if (selects[0] && r.duration) selects[0].value = r.duration;
            if (selects[1] && r.court) selects[1].value = r.court;
            if (checkboxes[0] && r['ÁèæÂú∞Ë™øÊï¥']) checkboxes[0].checked = true;
            if (checkboxes[1] && r['Êú™ÂÆö']) checkboxes[1].checked = true;
            if (checkboxes[2] && r['ÂΩìË©≤']) checkboxes[2].checked = true;
            if (textareas[0] && r.note) textareas[0].value = r.note;
          }
        }
      });
      
      checkCompletion();
      renderOutput();
    }

    document.getElementById('saveMasterBtn').addEventListener('click', () => {
      const savedFormData = JSON.parse(JSON.stringify(formData));
      saveMastersFromModal();
      document.getElementById('masterModal').classList.remove('show');
      renderInputForm();
      formData = savedFormData;
      restoreFormData();
      showToast('„Éû„Çπ„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    });

    function renderInputForm() {
      const container = document.getElementById('input-content');
      container.innerHTML = '';
      
      formData = {
        event: '', eventOther: '', eventDay: '',
        date: '',
        venue: '', venueOther: '',
        meetingRows: [],
        meetingNote: '',
        useHighway: false, highway: '', highwayNote: '',
        matchRows: [],
        refereeRows: [],
        staff: [], staffNote: '',
        refereeStaff: [], refereeNote: '',
        uniform: '', uniformNote: '',
        items: [], itemsNote: '',
        carpool: ''
      };

      const sections = [
        { id: 'basic', title: 'Âü∫Êú¨ÊÉÖÂ†±', render: renderBasicSection },
        { id: 'meeting', title: 'ÈõÜÂêàÊÉÖÂ†±', render: renderMeetingSectionV2 },
        { id: 'highway', title: 'È´òÈÄüÈÅìË∑Ø', render: renderHighwaySection },
        { id: 'match', title: 'Ë©¶Âêà„Çπ„Ç±„Ç∏„É•„Éº„É´', render: renderMatchSectionV2 },
        { id: 'referee', title: 'ÂØ©Âà§ÊãÖÂΩì', render: renderRefereeSectionV2 },
        { id: 'staff', title: '„Çπ„Çø„ÉÉ„Éï', render: renderStaffSection },
        { id: 'refereeStaff', title: 'ÂØ©Âà§Âì°', render: renderRefereeStaffSection },
        { id: 'uniform', title: '„É¶„Éã„Éï„Ç©„Éº„É†', render: renderUniformSection },
        { id: 'items', title: 'ÊåÅ„Å°Áâ©', render: renderItemsSection },
        { id: 'carpool', title: 'ÈÖçËªäÊÉÖÂ†±', render: renderCarpoolSection }
      ];

      sections.forEach(sec => {
        const section = createAccordionSection(sec.id, sec.title);
        sec.render(section.content);
        container.appendChild(section.element);
      });
    }

    function createAccordionSection(id, title) {
      const section = document.createElement('div');
      section.className = 'accordion-section';
      section.dataset.section = id;
      
      const header = document.createElement('div');
      header.className = 'accordion-header';
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'accordion-title';
      titleDiv.innerHTML = `<span class="accordion-check">‚úì</span> ${title}`;
      
      const icon = document.createElement('span');
      icon.className = 'accordion-icon';
      icon.textContent = '‚ñº';
      
      header.appendChild(titleDiv);
      header.appendChild(icon);
      
      const content = document.createElement('div');
      content.className = 'accordion-content';
      
      header.addEventListener('click', () => {
        section.classList.toggle('open');
      });
      
      section.appendChild(header);
      section.appendChild(content);
      
      return { element: section, content };
    }

    function markSectionCompleted(sectionId) {
      const section = document.querySelector(`[data-section="${sectionId}"]`);
      if (section) section.classList.add('completed');
    }

    function renderBasicSection(container) {
      addSelectWithOther(container, 'Â§ß‰ºöÂêç', 'event', masters.events);
      
      const label = document.createElement('label');
      label.textContent = 'Êó•Á®ãÂå∫ÂàÜ';
      const select = document.createElement('select');
      
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªªÊÑèÔºâ';
      select.appendChild(defaultOpt);
      
      const eventDays = masters.eventDays || DEFAULT_MASTERS.eventDays;
      eventDays.forEach(day => {
        const opt = document.createElement('option');
        opt.value = day;
        opt.textContent = day;
        select.appendChild(opt);
      });
      
      select.onchange = (e) => {
        formData.eventDay = e.target.value;
        checkCompletion();
      };
      
      container.appendChild(label);
      container.appendChild(select);
      
      addDateField(container, 'Êó•‰ªò', 'date');
      addSelectWithOther(container, '‰ºöÂ†¥Âêç', 'venue', masters.venues);
    }

    function renderMeetingSection(container) {
      for (let i = 0; i < 6; i++) {
        const meetingItem = document.createElement('div');
        meetingItem.className = 'meeting-item';
        meetingItem.dataset.meetingIdx = i;
        
        const header = document.createElement('div');
        header.className = 'accordion-header';
        
        const title = document.createElement('div');
        title.className = 'accordion-title';
        title.innerHTML = `<span class="accordion-check">‚úì</span> ÈõÜÂêàÊÉÖÂ†± ${i + 1}`;
        title.style.fontSize = '0.9rem';
        
        const icon = document.createElement('span');
        icon.className = 'accordion-icon';
        icon.textContent = '‚ñº';
        icon.style.fontSize = '1rem';
        
        header.appendChild(title);
        header.appendChild(icon);
        
        const content = document.createElement('div');
        content.className = 'accordion-content';
        content.appendChild(createMeetingRow(i));
        
        header.addEventListener('click', (e) => {
	    e.stopPropagation();
          meetingItem.classList.toggle('open');
        });
        
        meetingItem.appendChild(header);
        meetingItem.appendChild(content);
        container.appendChild(meetingItem);
        
        if (i === 0) {
          meetingItem.classList.add('open');
        }
      }
      
      addNoteField(container, 'meetingNote');
    }

    function createMeetingRow(idx) {
      const row = document.createElement('div');
      
      const fieldRow1 = document.createElement('div');
      fieldRow1.className = 'field-row';
      
      const timeGroup = document.createElement('div');
      timeGroup.className = 'field-group';
      const timeLabel = document.createElement('label');
      timeLabel.textContent = 'ÊôÇÈñì';
      const timeSelect = document.createElement('select');
      
      const defaultTimeOpt = document.createElement('option');
      defaultTimeOpt.value = '';
      defaultTimeOpt.textContent = 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      timeSelect.appendChild(defaultTimeOpt);
      
      for (let h = 6; h <= 22; h++) {
        for (let m = 0; m < 60; m += 5) {
          const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          const opt = document.createElement('option');
          opt.value = timeStr;
          opt.textContent = timeStr;
          timeSelect.appendChild(opt);
        }
      }
      
      timeSelect.onchange = (e) => {
        if (!formData.meetingRows[idx]) formData.meetingRows[idx] = {};
        formData.meetingRows[idx].time = e.target.value;
        updateMeetingCompletion(idx);
        checkCompletion();
      };
      
      timeGroup.appendChild(timeLabel);
      timeGroup.appendChild(timeSelect);
      
      const typeGroup = createFieldGroup('Á®ÆÈ°û', 'select', ['', 'ÈõÜÂêà', 'Âá∫Áô∫', 'Âà∞ÁùÄ', 'Áõ£Áù£ËÄÖ‰ºöË≠∞'], (e) => {
        if (!formData.meetingRows[idx]) formData.meetingRows[idx] = {};
        formData.meetingRows[idx].type = e.target.value;
        updateMeetingCompletion(idx);
        checkCompletion();
      });
      
      fieldRow1.appendChild(timeGroup);
      fieldRow1.appendChild(typeGroup);
      row.appendChild(fieldRow1);
      
      const fieldRow2 = document.createElement('div');
      fieldRow2.className = 'field-row full';
      
      const placeGroup = document.createElement('div');
      placeGroup.className = 'field-group';
      const placeLabel = document.createElement('label');
      placeLabel.textContent = 'Â†¥ÊâÄ';
      const placeSelect = document.createElement('select');
      
      const defaultPlaceOpt = document.createElement('option');
      defaultPlaceOpt.value = '';
      defaultPlaceOpt.textContent = 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      placeSelect.appendChild(defaultPlaceOpt);
      
      const meetingPlaces = masters.meetingPlaces || DEFAULT_MASTERS.meetingPlaces;
      meetingPlaces.forEach(place => {
        const opt = document.createElement('option');
        opt.value = place;
        opt.textContent = place;
        placeSelect.appendChild(opt);
      });
      
      const otherOpt = document.createElement('option');
      otherOpt.value = '__other__';
      otherOpt.textContent = '„Åù„ÅÆ‰ªñÔºàËá™Áî±ÂÖ•ÂäõÔºâ';
      placeSelect.appendChild(otherOpt);
      
      const placeInput = document.createElement('input');
      placeInput.placeholder = 'Â†¥ÊâÄ„ÇíÂÖ•Âäõ';
      placeInput.style.display = 'none';
      placeInput.style.marginTop = '8px';
      
      placeSelect.onchange = (e) => {
        if (!formData.meetingRows[idx]) formData.meetingRows[idx] = {};
        if (e.target.value === '__other__') {
          placeInput.style.display = 'block';
          formData.meetingRows[idx].place = placeInput.value;
          formData.meetingRows[idx].placeOther = placeInput.value;
        } else {
          placeInput.style.display = 'none';
          formData.meetingRows[idx].place = e.target.value;
          formData.meetingRows[idx].placeOther = '';
        }
        updateMeetingCompletion(idx);
        checkCompletion();
      };
      
      placeInput.oninput = (e) => {
        if (!formData.meetingRows[idx]) formData.meetingRows[idx] = {};
        formData.meetingRows[idx].place = e.target.value;
        formData.meetingRows[idx].placeOther = e.target.value;
        updateMeetingCompletion(idx);
        checkCompletion();
      };
      
      placeGroup.appendChild(placeLabel);
      placeGroup.appendChild(placeSelect);
      placeGroup.appendChild(placeInput);
      
      fieldRow2.appendChild(placeGroup);
      row.appendChild(fieldRow2);
      
      return row;
    }

  function updateMeetingCompletion(idx) {
    const meetingSection = document.querySelector(`.meeting-item[data-meeting-idx="${idx}"]`);
    if (!meetingSection) return;

    const m = formData.meetingRows[idx];

    // null „ÇÑ undefined„ÄÅÁ©∫„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅØÊú™ÂÖ•ÂäõÊâ±„ÅÑ
    if (!m || Object.keys(m).length === 0) {
      meetingSection.classList.remove("completed");
      return;
    }

    // „ÅÑ„Åö„Çå„Åã1„Å§„Åß„ÇÇÂÄ§„Åå„ÅÇ„Çå„Å∞ OKÔºàÁ©∫ÊñáÂ≠ó„ÅØÈô§Â§ñÔºâ
    const filled =
      (m.time && m.time !== '') ||
      (m.type && m.type !== '') ||
      (m.place && m.place !== '');

    if (filled) {
      meetingSection.classList.add("completed");
    } else {
      meetingSection.classList.remove("completed");
    }
  }


    function renderHighwaySection(container) {
      addCheckboxField(container, 'È´òÈÄüÈÅìË∑Ø„Çí‰ΩøÁî®', 'useHighway', () => {
        const hwContainer = document.getElementById('highway-fields');
        hwContainer.style.display = formData.useHighway ? 'block' : 'none';
      });
      
      const hwContainer = document.createElement('div');
      hwContainer.id = 'highway-fields';
      hwContainer.style.display = 'none';
      
      addTextField(hwContainer, 'È´òÈÄüÈÅìË∑Ø', 'highway', '‰æã: ÂÆáÈÉΩÂÆÆIC„ÄúÈªíÁ£ØÊùøÂÆ§IC');
      addNoteField(hwContainer, 'highwayNote');
      
      container.appendChild(hwContainer);
    }

    function renderMatchSection(container) {
      for (let i = 0; i < 6; i++) {
        container.appendChild(createMatchRow(i));
      }
    }

    function renderRefereeSection(container) {
      for (let i = 0; i < 6; i++) {
        container.appendChild(createRefereeRow(i));
      }
    }

    function renderStaffSection(container) {
      addCheckboxGroup(container, 'staff', masters.staff);
      addNoteField(container, 'staffNote');
    }

    function renderRefereeStaffSection(container) {
      addCheckboxGroup(container, 'refereeStaff', masters.referees);
      addNoteField(container, 'refereeNote');
    }

    function renderUniformSection(container) {
      addRadioGroup(container, 'uniform', masters.uniforms);
      addNoteField(container, 'uniformNote');
    }

    function renderItemsSection(container) {
      addCheckboxGroup(container, 'items', masters.items);
      addNoteField(container, 'itemsNote');
    }

    function renderCarpoolSection(container) {
      addTextareaField(container, 'ÈÖçËªäÊÉÖÂ†±', 'carpool', '‰æã:\nüöôÁü≥Áî∞Âè∑ Áü≥Áî∞Áà∂„ÄÅ„Åæ„ÇÑ„ÄÅ„Åü„Åè„Å®\nüöôÁî∞Â≥∂Âè∑ Áî∞Â≥∂Áà∂„ÄÅ„Åü„Åò„ÅÇ„Åä');
    }

    function addSelectWithOther(container, labelText, key, options) {
      const label = document.createElement('label');
      label.textContent = labelText;
      const select = document.createElement('select');
      
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      select.appendChild(defaultOpt);
      
      options.forEach(opt => {
        const optEl = document.createElement('option');
        optEl.value = opt;
        optEl.textContent = opt;
        select.appendChild(optEl);
      });
      
      const otherOpt = document.createElement('option');
      otherOpt.value = '__other__';
      otherOpt.textContent = '„Åù„ÅÆ‰ªñÔºàËá™Áî±ÂÖ•ÂäõÔºâ';
      select.appendChild(otherOpt);
      
      const otherInput = document.createElement('input');
      otherInput.placeholder = 'Ëá™Áî±ÂÖ•Âäõ';
      otherInput.style.display = 'none';
      otherInput.style.marginTop = '8px';
      
      select.onchange = (e) => {
        if (e.target.value === '__other__') {
          otherInput.style.display = 'block';
          formData[key] = '';
          formData[key + 'Other'] = otherInput.value;
        } else {
          otherInput.style.display = 'none';
          formData[key] = e.target.value;
          formData[key + 'Other'] = '';
        }
        checkCompletion();
      };
      
      otherInput.oninput = (e) => {
        formData[key + 'Other'] = e.target.value;
        checkCompletion();
      };
      
      container.appendChild(label);
      container.appendChild(select);
      container.appendChild(otherInput);
    }

    function addDateField(container, labelText, key) {
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.type = 'date';
      input.onchange = (e) => { formData[key] = e.target.value; checkCompletion(); };
      container.appendChild(label);
      container.appendChild(input);
    }

    function addTextField(container, labelText, key, placeholder) {
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.placeholder = placeholder || '';
      input.oninput = (e) => {
        formData[key] = e.target.value;
        checkCompletion();
      };
      container.appendChild(label);
      container.appendChild(input);
    }

    function addCheckboxField(container, labelText, key, callback) {
      const wrap = document.createElement('div');
      wrap.style.marginTop = '12px';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = key;
      checkbox.onchange = (e) => {
        formData[key] = e.target.checked;
        if (callback) callback();
        checkCompletion();
      };
      const label = document.createElement('label');
      label.htmlFor = key;
      label.textContent = labelText;
      label.style.display = 'inline';
      label.style.marginLeft = '8px';
      wrap.appendChild(checkbox);
      wrap.appendChild(label);
      container.appendChild(wrap);
    }

    function addCheckboxGroup(container, key, options) {
      const group = document.createElement('div');
      group.className = 'checkbox-group';
      group.id = `checkbox-group-${key}`;
      
      options.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = opt;
        cb.onchange = () => {
          const checked = Array.from(document.querySelectorAll(`#checkbox-group-${key} input:checked`)).map(c => c.value);
          formData[key] = checked;
          checkCompletion();
        };
        
        const lbl = document.createElement('label');
        lbl.textContent = opt;
        
        item.appendChild(cb);
        item.appendChild(lbl);
        group.appendChild(item);
      });
      
      container.appendChild(group);
    }

    function addRadioGroup(container, key, options) {
      const group = document.createElement('div');
      group.className = 'checkbox-group';
      
      options.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        
        const rb = document.createElement('input');
        rb.type = 'radio';
        rb.name = key;
        rb.value = opt;
        rb.onchange = (e) => {
          formData[key] = e.target.value;
          checkCompletion();
        };
        
        const lbl = document.createElement('label');
        lbl.textContent = opt;
        
        item.appendChild(rb);
        item.appendChild(lbl);
        group.appendChild(item);
      });
      
      container.appendChild(group);
    }

    function addTextareaField(container, labelText, key, placeholder) {
      const label = document.createElement('label');
      label.textContent = labelText;
      const textarea = document.createElement('textarea');
      textarea.rows = 4;
      textarea.placeholder = placeholder || '';
      textarea.oninput = (e) => {
        formData[key] = e.target.value;
        checkCompletion();
      };
      container.appendChild(label);
      container.appendChild(textarea);
    }

    function addNoteField(container, key) {
      const label = document.createElement('label');
      label.textContent = 'Ê≥®Ë®ò';
      label.style.fontSize = '0.85rem';
      const textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.placeholder = 'Ë£úË∂≥‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•';
      textarea.oninput = (e) => {
        formData[key] = e.target.value;
        checkCompletion();
      };
      container.appendChild(label);
      container.appendChild(textarea);
    }

    function createMatchRow(idx) {
      const row = document.createElement('div');
      row.className = 'dynamic-row';
      
      const header = document.createElement('div');
      header.className = 'dynamic-row-header';
      header.textContent = `Ë©¶Âêà ${idx + 1}`;
      row.appendChild(header);
      
      const fieldRow1 = document.createElement('div');
      fieldRow1.className = 'field-row';
      
      const timeGroup = createFieldGroup('ÊôÇÈñì', 'time', null, (e) => {
        if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
        formData.matchRows[idx].time = e.target.value;
        checkCompletion();
      });
      
      const opponentGroup = createFieldGroup('ÂØæÊà¶Áõ∏Êâã', 'text', null, (e) => {
        if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
        formData.matchRows[idx].opponent = e.target.value;
        checkCompletion();
      });
      
      fieldRow1.appendChild(timeGroup);
      fieldRow1.appendChild(opponentGroup);
      row.appendChild(fieldRow1);
      
      const fieldRow2 = document.createElement('div');
      fieldRow2.className = 'field-row';
      
      const durationGroup = createFieldGroup('Ë©¶ÂêàÊôÇÈñì', 'select', 
        ['', '15-5-15', '20-5-20', '15ÂàÜ1Êú¨', '20ÂàÜ1Êú¨', '25ÂàÜ1Êú¨', '„Åù„ÅÆ‰ªñ'], (e) => {
        if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
        formData.matchRows[idx].duration = e.target.value;
        checkCompletion();
      });
      
      const courtGroup = createFieldGroup('„Ç≥„Éº„Éà', 'select',
        ['', 'A„Ç≥„Éº„Éà', 'B„Ç≥„Éº„Éà', 'C„Ç≥„Éº„Éà', 'D„Ç≥„Éº„Éà', '„Åù„ÅÆ‰ªñ'], (e) => {
        if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
        formData.matchRows[idx].court = e.target.value;
        checkCompletion();
      });
      
      fieldRow2.appendChild(durationGroup);
      fieldRow2.appendChild(courtGroup);
      row.appendChild(fieldRow2);
      
      const specialRow = document.createElement('div');
      specialRow.style.marginTop = '12px';
      specialRow.style.display = 'flex';
      specialRow.style.gap = '12px';
      
      ['ÁèæÂú∞Ë™øÊï¥', 'Êú™ÂÆö'].forEach(sp => {
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `match${idx}-${sp}`;
        cb.style.width = '20px';
        cb.style.height = '20px';
        cb.onchange = (e) => {
          if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
          formData.matchRows[idx][sp] = e.target.checked;
          checkCompletion();
        };
        const lbl = document.createElement('label');
        lbl.htmlFor = `match${idx}-${sp}`;
        lbl.textContent = sp;
        lbl.style.margin = '0';
        lbl.style.fontWeight = '500';
        wrap.appendChild(cb);
        wrap.appendChild(lbl);
        specialRow.appendChild(wrap);
      });
      row.appendChild(specialRow);
      
      const noteLabel = document.createElement('label');
      noteLabel.textContent = 'Ê≥®Ë®ò';
      noteLabel.style.fontSize = '0.85rem';
      noteLabel.style.marginTop = '12px';
      const noteArea = document.createElement('textarea');
      noteArea.rows = 2;
      noteArea.placeholder = 'Ë£úË∂≥‰∫ãÈ†Ö';
      noteArea.oninput = (e) => {
        if (!formData.matchRows[idx]) formData.matchRows[idx] = {};
        formData.matchRows[idx].note = e.target.value;
        checkCompletion();
      };
      row.appendChild(noteLabel);
      row.appendChild(noteArea);
      
      return row;
    }

    function createRefereeRow(idx) {
      const row = document.createElement('div');
      row.className = 'dynamic-row';
      
      const header = document.createElement('div');
      header.className = 'dynamic-row-header';
      header.textContent = `ÂØ©Âà§ ${idx + 1}`;
      row.appendChild(header);
      
      const fieldRow1 = document.createElement('div');
      fieldRow1.className = 'field-row';
      
      const timeGroup = createFieldGroup('ÊôÇÈñì', 'time', null, (e) => {
        if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
        formData.refereeRows[idx].time = e.target.value;
        checkCompletion();
      });
      
      const opponentGroup = createFieldGroup('ÂØæÊà¶Áõ∏Êâã', 'text', null, (e) => {
        if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
        formData.refereeRows[idx].opponent = e.target.value;
        checkCompletion();
      });
      
      fieldRow1.appendChild(timeGroup);
      fieldRow1.appendChild(opponentGroup);
      row.appendChild(fieldRow1);
      
      const fieldRow2 = document.createElement('div');
      fieldRow2.className = 'field-row';
      
      const durationGroup = createFieldGroup('Ë©¶ÂêàÊôÇÈñì', 'select', 
        ['', '15-5-15', '20-5-20', '15ÂàÜ1Êú¨', '20ÂàÜ1Êú¨', '25ÂàÜ1Êú¨', '„Åù„ÅÆ‰ªñ'], (e) => {
        if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
        formData.refereeRows[idx].duration = e.target.value;
        checkCompletion();
      });
      
      const courtGroup = createFieldGroup('„Ç≥„Éº„Éà', 'select',
        ['', 'A„Ç≥„Éº„Éà', 'B„Ç≥„Éº„Éà', 'C„Ç≥„Éº„Éà', 'D„Ç≥„Éº„Éà', '„Åù„ÅÆ‰ªñ'], (e) => {
        if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
        formData.refereeRows[idx].court = e.target.value;
        checkCompletion();
      });
      
      fieldRow2.appendChild(durationGroup);
      fieldRow2.appendChild(courtGroup);
      row.appendChild(fieldRow2);
      
      const specialRow = document.createElement('div');
      specialRow.style.marginTop = '12px';
      specialRow.style.display = 'flex';
      specialRow.style.gap = '12px';
      specialRow.style.flexWrap = 'wrap';
      
      ['ÁèæÂú∞Ë™øÊï¥', 'Êú™ÂÆö', 'ÂΩìË©≤'].forEach(sp => {
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `referee${idx}-${sp}`;
        cb.style.width = '20px';
        cb.style.height = '20px';
        cb.onchange = (e) => {
          if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
          formData.refereeRows[idx][sp] = e.target.checked;
          checkCompletion();
        };
        const lbl = document.createElement('label');
        lbl.htmlFor = `referee${idx}-${sp}`;
        lbl.textContent = sp;
        lbl.style.margin = '0';
        lbl.style.fontWeight = '500';
        wrap.appendChild(cb);
        wrap.appendChild(lbl);
        specialRow.appendChild(wrap);
      });
      row.appendChild(specialRow);
      
      const noteLabel = document.createElement('label');
      noteLabel.textContent = 'Ê≥®Ë®ò';
      noteLabel.style.fontSize = '0.85rem';
      noteLabel.style.marginTop = '12px';
      const noteArea = document.createElement('textarea');
      noteArea.rows = 2;
      noteArea.placeholder = 'Ë£úË∂≥‰∫ãÈ†Ö';
      noteArea.oninput = (e) => {
        if (!formData.refereeRows[idx]) formData.refereeRows[idx] = {};
        formData.refereeRows[idx].note = e.target.value;
        checkCompletion();
      };
      row.appendChild(noteLabel);
      row.appendChild(noteArea);
      
      return row;
    }

    function createFieldGroup(label, type, options, callback) {
      const group = document.createElement('div');
      group.className = 'field-group';
      
      const lbl = document.createElement('label');
      lbl.textContent = label;
      group.appendChild(lbl);
      
      let input;
      if (type === 'select') {
        input = document.createElement('select');
        options.forEach(opt => {
          const optEl = document.createElement('option');
          optEl.value = opt;
          optEl.textContent = opt || 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          input.appendChild(optEl);
        });
        input.onchange = callback;
      } else {
        input = document.createElement('input');
        input.type = type;
        if (type === 'time') input.placeholder = '‰æã: 09:00';
        input.oninput = callback;
      }
      
      group.appendChild(input);
      return group;
    }

    function checkCompletion() {
      if ((formData.event || formData.eventOther) && formData.date && (formData.venue || formData.venueOther)) {
        markSectionCompleted('basic');
      }
      
      if (formData.meetingRows.some(m => m && (m.time || m.type || m.place))) {
        markSectionCompleted('meeting');
      }
      
      if (formData.useHighway && formData.highway) {
        markSectionCompleted('highway');
      }
      
      if (formData.matchRows.some(m => m && (m.time || m.opponent))) {
        markSectionCompleted('match');
      }
      
      if (formData.refereeRows.some(r => r && (r.time || r.opponent))) {
        markSectionCompleted('referee');
      }
      
      if (formData.staff && formData.staff.length > 0) {
        markSectionCompleted('staff');
      }
      
      if (formData.refereeStaff && formData.refereeStaff.length > 0) {
        markSectionCompleted('refereeStaff');
      }
      
      if (formData.uniform) {
        markSectionCompleted('uniform');
      }
      
      if (formData.items && formData.items.length > 0) {
        markSectionCompleted('items');
      }
      
      if (formData.carpool) {
        markSectionCompleted('carpool');
      }
    }

    function renderOutput() {
      const parts = [];
      
      parts.push('„ÅäÁñ≤„ÇåÊßò„Åß„Åô!');
      
      const eventName = formData.eventOther || formData.event;
      if (eventName) {
        const fullEventName = eventName + (formData.eventDay || '');
        parts.push(`${fullEventName}„ÅÆ„ÅîÈÄ£Áµ°„Åß„Åô„ÄÇ`);
        parts.push('');
      }
      
      if (formData.date) {
        parts.push(formatDateJp(formData.date));
      }
      
      const venueName = formData.venueOther || formData.venue;
      if (venueName) {
        parts.push(`ü•Ö${venueName}`);
        parts.push('');
      }
      
      const meetings = formData.meetingRows.filter(m => m && (m.time || m.type || m.place));
      if (meetings.length > 0) {
        parts.push('‚è∞ÈõÜÂêà');
        meetings.forEach(m => {
          let line = '';
          if (m.time) line += m.time;
          if (m.type) line += (line ? ' ' : '') + m.type;
          if (m.place) line += (line ? ' ' : '') + m.place;
          if (line) parts.push(line);
        });
        if (formData.meetingNote) parts.push(`‚Äª${formData.meetingNote}`);
        parts.push('');
      }
      
      if (formData.useHighway && formData.highway) {
        parts.push(`‚ÄªÈ´òÈÄüÈÅìË∑Ø(${formData.highway})‰ΩøÁî®„Åó„Åæ„Åô`);
        if (formData.highwayNote) parts.push(`‚Äª${formData.highwayNote}`);
        parts.push('');
      }
      
      const matches = formData.matchRows.filter(m => m && (m.time || m.opponent || m['ÁèæÂú∞Ë™øÊï¥'] || m['Êú™ÂÆö']));
      if (matches.length > 0) {
        parts.push('‚öΩÔ∏èË©¶ÂêàÊó•Á®ã');
        matches.forEach(m => {
          if (m['ÁèæÂú∞Ë™øÊï¥']) {
            parts.push('ÁèæÂú∞Ë™øÊï¥');
          } else if (m['Êú™ÂÆö']) {
            parts.push('Êú™ÂÆö');
          } else {
            let line = m.time || '';
            if (m.opponent) line += ` vs ${m.opponent}`;
            if (m.duration) line += ` / ${m.duration}`;
            if (m.court) line += ` / ${m.court}`;
            if (line) parts.push(line);
          }
          if (m.note) parts.push(`‚Äª${m.note}`);
        });
        parts.push('');
      }
      
      const referees = formData.refereeRows.filter(r => r && (r.time || r.opponent || r['ÁèæÂú∞Ë™øÊï¥'] || r['Êú™ÂÆö'] || r['ÂΩìË©≤']));
      if (referees.length > 0) {
        parts.push('‚åöÂØ©Âà§');
        referees.forEach(r => {
          if (r['ÁèæÂú∞Ë™øÊï¥']) {
            parts.push('ÁèæÂú∞Ë™øÊï¥');
          } else if (r['Êú™ÂÆö']) {
            parts.push('Êú™ÂÆö');
          } else if (r['ÂΩìË©≤']) {
            parts.push('ÂΩìË©≤');
          } else {
            let line = r.time || '';
            if (r.opponent) line += ` ${r.opponent}`;
            if (r.duration) line += ` / ${r.duration}`;
            if (r.court) line += ` / ${r.court}`;
            if (line) parts.push(line);
          }
          if (r.note) parts.push(`‚Äª${r.note}`);
        });
        parts.push('');
      }
      
      if (formData.staff && formData.staff.length > 0) {
        parts.push('‚ô¶Ô∏è„Çπ„Çø„ÉÉ„Éï');
        parts.push(formData.staff.join('„ÄÅ'));
        if (formData.staffNote) parts.push(`‚Äª${formData.staffNote}`);
        parts.push('');
      }
      
      if (formData.refereeStaff && formData.refereeStaff.length > 0) {
        parts.push('‚ô¶Ô∏èÂØ©Âà§');
        parts.push(formData.refereeStaff.join('„ÄÅ'));
        if (formData.refereeNote) parts.push(`‚Äª${formData.refereeNote}`);
        parts.push('');
      }
      
      if (formData.uniform) {
        parts.push('‚öΩ„É¶„Éã„Éï„Ç©„Éº„É†');
        parts.push(formData.uniform);
        if (formData.uniformNote) parts.push(`‚Äª${formData.uniformNote}`);
        parts.push('');
      }
      
      if (formData.items && formData.items.length > 0) {
        parts.push('‚öΩÊåÅ„Å°Áâ©');
        parts.push(formData.items.join('„ÄÅ'));
        if (formData.itemsNote) parts.push(`‚Äª${formData.itemsNote}`);
        parts.push('');
      }
      
      if (formData.carpool) {
        parts.push('‚ñ†ÈÖçËªä');
        parts.push(formData.carpool);
        parts.push('');
      }
      
      parts.push('‰ª•‰∏ä„ÄÅ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô');
      
      document.getElementById('output').textContent = parts.join('\n');
    }

    async function copyOutput() {
      const text = document.getElementById('output').textContent || '';
      if (!text.trim()) {
        showToast('„Ç≥„Éî„Éº„Åô„ÇãÊñáÁ´†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
      } catch (e) {
        showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }

    function saveToHistory() {
      const text = document.getElementById('output').textContent || '';
      if (!text.trim()) {
        showToast('‰øùÂ≠ò„Åô„ÇãÊñáÁ´†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }
      const hist = loadHistory();
      hist.push({ ts: Date.now(), text });
      saveHistory(hist);
      showToast('Â±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    }

    function renderHistory() {
      const hist = loadHistory();
      const container = document.getElementById('history-content');
      container.innerHTML = '';
      
      if (!hist.length) {
        container.innerHTML = '<div class="empty-state">Â±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      hist.slice().reverse().forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        const dt = new Date(item.ts);
        const when = `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
        
        const header = document.createElement('div');
        header.className = 'history-header';
        header.textContent = when;
        
        const text = document.createElement('div');
        text.className = 'history-text';
        text.textContent = item.text;
        
        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '8px';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn primary';
        copyBtn.textContent = '„Ç≥„Éî„Éº';
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(item.text).then(() => showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
        };
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn';
        delBtn.textContent = 'ÂâäÈô§';
        delBtn.onclick = () => {
          if (confirm('„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
            const newHist = loadHistory().filter((_, i) => i !== (hist.length - 1 - idx));
            saveHistory(newHist);
            renderHistory();
            showToast('ÂâäÈô§„Åó„Åæ„Åó„Åü');
          }
        };
        
        btnRow.appendChild(copyBtn);
        btnRow.appendChild(delBtn);
        
        div.appendChild(header);
        div.appendChild(text);
        div.appendChild(btnRow);
        container.appendChild(div);
      });
    }

    document.getElementById('copyBtn').addEventListener('click', copyOutput);
    document.getElementById('saveBtn').addEventListener('click', saveToHistory);

    renderInputForm();
    renderOutput();
  </script>

<script>
  (function(){
    function relayoutSection(sectionId, renderFn){
      const sec = document.querySelector(`[data-section="${sectionId}"] .accordion-content`);
      if (!sec) return; sec.innerHTML=''; renderFn(sec);
    }
    function FD(){ try { return formData; } catch(e){ return window.formData || (window.formData={}); } }

    window.renderMeetingSectionV2 = function(container){
      const fd = FD(); fd.meetingRows = Array.isArray(fd.meetingRows)?fd.meetingRows:[]; if (fd.meetingRows.length===0) fd.meetingRows.push({});
      const list=document.createElement('div'); list.id='meeting-list'; container.appendChild(list);
      const renderItem=(i)=>{ const it=document.createElement('div'); it.className='meeting-item'; it.dataset.meetingIdx=i;
        const header=document.createElement('div'); header.className='accordion-header';
        const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> ÈõÜÂêàÊÉÖÂ†± ${i+1}`; title.style.fontSize='0.9rem';
        const actions=document.createElement('div'); actions.className='section-actions';
        const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
        del.onclick=(e)=>{ e.stopPropagation(); fd.meetingRows.splice(i,1); relayoutSection('meeting', renderMeetingSectionV2); if (window.checkCompletion) window.checkCompletion(); };
        const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
        actions.appendChild(del); actions.appendChild(icon);
        header.appendChild(title); header.appendChild(actions);
        const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createMeetingRow(i));
        header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
        it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
        if (i===0) it.classList.add('open'); if (window.updateMeetingCompletion) window.updateMeetingCompletion(i);
        return it; };
      for (let i=0;i<fd.meetingRows.length && i<6;i++) renderItem(i);
      const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã ÈõÜÂêàÊÉÖÂ†±„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
      addBtn.onclick=()=>{ if (fd.meetingRows.length>=6){ window.showToast && window.showToast('ÈõÜÂêàÊÉÖÂ†±„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
        fd.meetingRows.push({}); const it=renderItem(fd.meetingRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
      container.appendChild(addBtn); if (window.addNoteField) window.addNoteField(container,'meetingNote');
    };

    window.renderMatchSectionV2 = function(container){
      const fd = FD(); fd.matchRows = Array.isArray(fd.matchRows)?fd.matchRows:[]; if (fd.matchRows.length===0) fd.matchRows.push({});
      const list=document.createElement('div'); list.id='match-list'; container.appendChild(list);
      const renderItem=(i)=>{ const it=document.createElement('div'); it.className='match-item'; it.dataset.matchIdx=i;
        const header=document.createElement('div'); header.className='accordion-header';
        const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> Ë©¶Âêà ${i+1}`; title.style.fontSize='0.9rem';
        const actions=document.createElement('div'); actions.className='section-actions';
        const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
        del.onclick=(e)=>{ e.stopPropagation(); fd.matchRows.splice(i,1); relayoutSection('match', renderMatchSectionV2); if (window.checkCompletion) window.checkCompletion(); };
        const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
        actions.appendChild(del); actions.appendChild(icon);
        header.appendChild(title); header.appendChild(actions);
        const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createMatchRow(i));
        header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
        it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
        if (i===0) it.classList.add('open'); if (window.updateMatchCompletion) window.updateMatchCompletion(i);
        return it; };
      for (let i=0;i<fd.matchRows.length && i<6;i++) renderItem(i);
      const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã Ë©¶Âêà„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
      addBtn.onclick=()=>{ if (fd.matchRows.length>=6){ window.showToast && window.showToast('Ë©¶Âêà„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
        fd.matchRows.push({}); const it=renderItem(fd.matchRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
      container.appendChild(addBtn);
    };

    window.renderRefereeSectionV2 = function(container){
      const fd = FD(); fd.refereeRows = Array.isArray(fd.refereeRows)?fd.refereeRows:[]; if (fd.refereeRows.length===0) fd.refereeRows.push({});
      const list=document.createElement('div'); list.id='referee-list'; container.appendChild(list);
      const renderItem=(i)=>{ const it=document.createElement('div'); it.className='referee-item'; it.dataset.refereeIdx=i;
        const header=document.createElement('div'); header.className='accordion-header';
        const title=document.createElement('div'); title.className='accordion-title'; title.innerHTML=`<span class="accordion-check">‚úì</span> ÂØ©Âà§ ${i+1}`; title.style.fontSize='0.9rem';
        const actions=document.createElement('div'); actions.className='section-actions';
        const del=document.createElement('button'); del.className='delete-row-btn'; del.textContent='ÂâäÈô§';
        del.onclick=(e)=>{ e.stopPropagation(); fd.refereeRows.splice(i,1); relayoutSection('referee', renderRefereeSectionV2); if (window.checkCompletion) window.checkCompletion(); };
        const icon=document.createElement('span'); icon.className='accordion-icon'; icon.textContent='‚ñº'; icon.style.fontSize='1rem';
        actions.appendChild(del); actions.appendChild(icon);
        header.appendChild(title); header.appendChild(actions);
        const contentEl=document.createElement('div'); contentEl.className='accordion-content'; contentEl.appendChild(createRefereeRow(i));
        header.addEventListener('click',(e)=>{ e.stopPropagation(); it.classList.toggle('open'); });
        it.appendChild(header); it.appendChild(contentEl); list.appendChild(it);
        if (i===0) it.classList.add('open'); if (window.updateRefereeCompletion) window.updateRefereeCompletion(i);
        return it; };
      for (let i=0;i<fd.refereeRows.length && i<6;i++) renderItem(i);
      const addBtn=document.createElement('button'); addBtn.className='add-row-btn'; addBtn.textContent='Ôºã ÂØ©Âà§„ÇíËøΩÂä†ÔºàÊúÄÂ§ß6‰ª∂Ôºâ';
      addBtn.onclick=()=>{ if (fd.refereeRows.length>=6){ window.showToast && window.showToast('ÂØ©Âà§„ÅØÊúÄÂ§ß6‰ª∂„Åæ„Åß„Åß„Åô'); return; }
        fd.refereeRows.push({}); const it=renderItem(fd.refereeRows.length-1); it.classList.add('open'); it.scrollIntoView({behavior:'smooth', block:'nearest'}); };
      container.appendChild(addBtn);
    };
  })();
</script>
</body>
</html>
